name: Go1 Catkin

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev

jobs: 
  build: 
    runs-on: ubuntu-20.04
    env:
      ROS_DISTRO: noetic
    steps:
      - uses: actions/checkout@v2
        with: 
          submodules: recursive
      - name: Install ROS
        run: |
          sudo apt-get update
          sudo sh -c 'echo "deb http://packages.ros.org/ros/ubuntu $(lsb_release -sc) main" > /etc/apt/sources.list.d/ros-latest.list'
          sudo apt-get -y install curl
          curl -s https://raw.githubusercontent.com/ros/rosdistro/master/ros.asc | sudo apt-key add -
          sudo apt-get update
          sudo apt-get install ros-$ROS_DISTRO-desktop-full
          echo "source /opt/ros/noetic/setup.bash" >> ~/.bashrc
          source ~/.bashrc
          sudo apt-get install -y python3-rosdep python3-rosinstall python3-rosinstall-generator python3-wstool build-essential
          sudo rosdep init
          rosdep update
          cd ~/..
          source /opt/ros/$ROS_DISTRO/setup.bash
          sudo apt-get -y install python3-catkin-tools
          mkdir -p ~/catkin_ws/src/
          cd ~/catkin_ws/
          catkin build
          source devel/setup.bash
          echo "source ~/catkin_ws/devel/setup.bash" >> ~/.bashrc
          source ~/.bashrc
          sudo apt-get install unzip wget
          sudo apt-get install -y libglib2.0-dev
          cd
          wget https://github.com/lcm-proj/lcm/releases/download/v1.4.0/lcm-1.4.0.zip 
          unzip lcm-1.4.0.zip 
          mv lcm-1.4.0 lcm
          rm lcm-1.4.0.zip
          cd lcm 
          mkdir build
          cd build
          cmake ../
          make
          make install
          cd
          git clone https://github.com/msgpack/msgpack-c.git
          cd msgpack-c
          git checkout cpp_master
          cmake .
          sudo cmake --build . --target install
          cd
          git clone --branch fix https://github.com/JonasFovea/unitree_legged_sdk.git
          cd ~/unitree_legged_sdk
          mkdir build
          cd build
          cmake ../
          make
          echo "export UNITREE_LEGGED_SDK_PATH=~/unitree_legged_sdk" >> ~/.bashrc
          echo 'export UNITREE_PLATFORM="amd64"' >> ~/.bashrc
          source ~/.bashrc
          cd ~/catkin_ws/src/
          git clone --branch chip https://github.com/JonasFovea/unitree_ros_to_real.git
          cd ~/catkin_ws
          rosdep install --from-paths src --ignore-src -r -y
          source devel/setup.bash
          catkin build
      - name: Install Package
        run: |
          source /opt/ros/$ROS_DISTRO/setup.bash
          rosdep update
          ln -s $GITHUB_WORKSPACE ~/catkin_ws/src/go1controller
          cd ~/catkin_ws
          rosdep install --from-paths src --ignore-src -r -s
          rosdep install --from-paths src --ignore-src -ry
      - name: Catkin build
        run: |
          source /opt/ros/$ROS_DISTRO/setup.bash
          cd ~/catkin_ws
          catkin build --no-status
          source devel/setup.bash
